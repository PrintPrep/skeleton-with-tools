generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// ---------------------- User ----------------------
model User {
  id         String      @id @default(uuid())
  email      String      @unique
  password   String
  name       String?
  role       String?
  createdAt  DateTime    @default(now())

  projects   Project[]
  uploads    PdfFile[]         @relation("UploadedBy")
  pdfOps     PdfOperations[]   @relation("RequestedBy")
  payments   Payment[]
  auditLogs  AuditLog[]
}

/// ---------------------- Project ----------------------
model Project {
  id        String      @id @default(uuid())
  userid    String?
  name      String
  createdAt DateTime    @default(now())

  user      User?       @relation(fields: [userid], references: [id], onDelete: Cascade)
  files     ProjectFile[]
  operations PdfOperations[]
}

/// ---------------------- PDF Files ----------------------
model PdfFile {
  id             String       @id @default(uuid())
  original_name  String
  storage_url    String
  file_size_in_kb Int?
  page_count     Int?
  uploaded_by_id String?
  created_at     DateTime     @default(now())
  sha256         String?
  page_type      String?

  uploadedBy     User?        @relation("UploadedBy", fields: [uploaded_by_id], references: [id], onDelete: SetNull)
  operations     PdfFilePdfOperations[]
  projectFiles   ProjectFile[]
}

/// ---------------------- PDF Operations ----------------------
model PdfOperations {
  id             String    @id @default(uuid())
  job_type       String
  params         Json?
  requestedby_id String?
  project_id     String?
  status         String?
  created_at     DateTime   @default(now())
  completed_at   DateTime?

  requestedBy    User?        @relation("RequestedBy", fields: [requestedby_id], references: [id], onDelete: SetNull)
  project        Project?     @relation(fields: [project_id], references: [id], onDelete: SetNull)
  pdfFiles       PdfFilePdfOperations[]
  jobs           Job[]
}

/// ---------------------- Project File (Join Table) ----------------------
model ProjectFile {
  project_id  String
  pdf_file_id String
  is_final    Boolean     @default(false)

  project     Project     @relation(fields: [project_id], references: [id], onDelete: Cascade)
  pdfFile     PdfFile     @relation(fields: [pdf_file_id], references: [id], onDelete: Cascade)

  @@id([project_id, pdf_file_id])
}

/// ---------------------- PDF File - PDF Operations ----------------------
model PdfFilePdfOperations {
  id                String @id @default(uuid())
  pdf_operations_id String
  pdf_file_id       String
  role              String?
  order_index       Int?

  pdfOperations     PdfOperations @relation(fields: [pdf_operations_id], references: [id], onDelete: Cascade)
  pdfFile           PdfFile       @relation(fields: [pdf_file_id], references: [id], onDelete: Cascade)
}

/// ---------------------- Payment ----------------------
model Payment {
  id               String   @id @default(uuid())
  userid           String?
  provider         String?
  providerChargeId String?
  amountCents      Int?
  status           String?
  createdAt        DateTime @default(now())

  user             User?    @relation(fields: [userid], references: [id], onDelete: SetNull)
}

/// ---------------------- Audit Log ----------------------
model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String?
  resource  String?
  details   Json?
  created_at DateTime @default(now())

  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
}

/// ---------------------- Job ----------------------
model Job {
  id           String    @id @default(uuid())
  operation_id String
  status       String?
  attempts     Int       @default(0)
  workerid     String?
  started_at   DateTime?
  finished_at  DateTime?
  error        String?
  created_at   DateTime  @default(now())

  operation    PdfOperations @relation(fields: [operation_id], references: [id], onDelete: Cascade)
}
